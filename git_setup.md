# Настройка Git для нескольких пользователей на одном сервере

## Как это работает

### Логика подхода
1. На сервере все работают под одним системным пользователем
2. Но коммиты в Git должны быть от разных пользователей
3. Git определяет автора коммита по двум параметрам:
   - Имя пользователя (user.name)
   - Email пользователя (user.email)
4. Эти параметры задаются через переменные окружения, уникальные для каждой сессии

### Как работают переменные окружения
1. Каждый раз, когда вы открываете новый терминал, создается новая сессия
2. У каждой сессии свой набор переменных окружения
3. Когда вы выполняете команду переключения пользователя (например, `git-ivan`):
   - Устанавливаются переменные `GIT_AUTHOR_NAME` и `GIT_AUTHOR_EMAIL`
   - Эти переменные существуют только в текущей сессии
   - При создании коммита Git использует эти переменные
4. Когда вы закрываете терминал:
   - Сессия завершается
   - Все переменные окружения удаляются
   - В новой сессии нужно заново выполнить команду

### Как работает защита
1. Перед каждым коммитом Git запускает pre-commit хук
2. Хук проверяет:
   - Установлены ли переменные окружения
   - Соответствует ли email имени пользователя
   - Разрешено ли это имя пользователя
3. Если что-то не так:
   - Коммит блокируется
   - Выводится понятное сообщение об ошибке
   - Предлагается выполнить нужную команду

## Установка

### 0. Предварительные требования
- Git должен быть установлен
- У вас должны быть права sudo
- Bash версии 4.0 или выше

### 1. Скачайте скрипт настройки
```bash
# Скачать скрипт
curl -O https://raw.githubusercontent.com/your-repo/git_users.sh
# Сделать скрипт исполняемым
chmod +x git_users.sh
# Проверить содержимое скрипта (рекомендуется)
less git_users.sh
```

### 2. Запустите скрипт
```bash
sudo ./git_users.sh
```

При запуске скрипт:
1. Создаст резервную копию существующих настроек Git
2. Спросит количество пользователей для настройки
3. Для каждого пользователя запросит:
   - Имя команды (например, `ivan` для создания команды `git-ivan`)
   - Отображаемое имя пользователя
   - Email (с проверкой корректности)
   - Имя пользователя для Git (опционально)
4. Создаст все необходимые файлы и команды
5. Настроит защиту от ошибок через pre-commit хук

### 3. Примените изменения
```bash
source ~/.bashrc
```

## Использование

### 1. Начало работы
1. Подключитесь к серверу:
```bash
ssh user@server
```

2. Укажите, кто вы (используйте команду, созданную при установке):
```bash
git-ivan  # пример для пользователя Иван
```

3. Проверьте настройки:
```bash
git-check
```

### 2. Работа с Git

1. Получите последние изменения:
```bash
git pull
```

2. Внесите изменения в код

3. Добавьте изменения:
```bash
git add .
```

4. Создайте коммит:
```bash
# Для небольших изменений:
git commit -m "feat: Короткое описание"

# Для важных изменений:
git commit -m "feat: Краткое описание" \
-m "Подробное описание:" \
-m "1. Что было сделано" \
-m "2. Почему это важно" \
-m "3. Как это работает"
```

5. Отправьте изменения:
```bash
git push
```

## Частые проблемы и их решение

### 1. "Забыл выполнить команду переключения пользователя"

Проблема: pre-commit хук не дает сделать коммит

Решение: Выполните вашу команду переключения пользователя (например, `git-ivan`)

### 2. "Сделал коммит от чужого имени"

Изменить автора последнего коммита:
```bash
git commit --amend --reset-author
# Если коммит уже отправлен
git push --force  # Будьте осторожны с force push!
```

### 3. "Не помню, от чьего имени сделан коммит"

```bash
# Посмотреть автора последнего коммита
git log -1 --pretty=format:"%an <%ae>"

# Посмотреть все свои коммиты за сегодня
git log --since="6am" --author="ваше_имя"
```

### 4. "Хочу добавить нового пользователя"

Запустите скрипт настройки повторно:
```bash
sudo ./git_users.sh
```

### 5. "Хочу восстановить предыдущие настройки"

Если что-то пошло не так, вы можете восстановить предыдущие настройки:
```bash
# Восстановить .gitconfig
mv ~/.gitconfig.backup ~/.gitconfig

# Удалить созданные команды (замените user1, user2 на ваши)
sudo rm /usr/local/bin/git-user1 /usr/local/bin/git-user2

# Удалить хуки
rm -rf ~/.git-templates
```

### 6. "Не работает автодополнение команд"

Добавьте в ваш ~/.bashrc или ~/.zshrc:
```bash
# Автодополнение для git-команд
for cmd in /usr/local/bin/git-*; do
    complete -F _git "${cmd##*/}"
done
```

### 7. "Как проверить текущие настройки всех пользователей"

```bash
# Показать все доступные git-команды
ls -l /usr/local/bin/git-*

# Показать содержимое pre-commit хука
cat ~/.git-templates/hooks/pre-commit
```
